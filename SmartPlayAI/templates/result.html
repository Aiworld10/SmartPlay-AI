<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SmartPlayAI - Result</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* CSS Variables for Light and Dark Themes */
        :root {
            --bg-primary: #f4f6fa;
            --bg-secondary: #fff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #495057;
            --border-color: #dee2e6;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --link-color: #007bff;
        }

        body.dark-mode {
            --bg-primary: #0a0e27;
            --bg-secondary: #1e2540;
            --bg-tertiary: #252b48;
            --text-primary: #e0e6ff;
            --text-secondary: #a8b3cf;
            --text-muted: #8891aa;
            --border-color: #2d3454;
            --card-shadow: rgba(107, 42, 255, 0.2);
            --link-color: #a78bfa;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: #0a0e27;
            background-image:
                radial-gradient(at 20% 30%, rgba(107, 42, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 70%, rgba(139, 92, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 50% 50%, rgba(167, 139, 250, 0.05) 0px, transparent 50%);
        }

        .result-container {
            max-width: 700px;
            width: 100%;
            margin: 20px auto;
            background: var(--bg-secondary, #fff);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--card-shadow, rgba(0, 0, 0, 0.1));
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
        }

        body.dark-mode .result-container {
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(107, 42, 255, 0.2), 0 0 20px rgba(107, 42, 255, 0.1);
        }

        .verdict-badge {
            display: inline-block;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .verdict-good {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .verdict-bad {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }

        .score-display {
            font-size: 48px;
            font-weight: 700;
            color: #007bff;
            margin: 20px 0;
        }

        .evaluation-box {
            background: var(--bg-tertiary, #f8f9fa);
            border-radius: 8px;
            padding: 25px;
            margin: 30px 0;
            border-left: 4px solid var(--link-color, #007bff);
            transition: all 0.3s ease;
        }

        body.dark-mode .evaluation-box {
            box-shadow: 0 4px 15px rgba(107, 42, 255, 0.15);
        }

        .evaluation-text {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-muted, #495057);
            text-align: left;
        }

        .progress-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            font-weight: 600;
            color: #6c757d;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-next {
            flex: 1;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.05);
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #212529;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .dark-mode-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .dark-mode-toggle {
            background: rgba(107, 42, 255, 0.3);
            border-color: rgba(167, 139, 250, 0.5);
            color: white;
            box-shadow: 0 0 15px rgba(107, 42, 255, 0.4);
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: rgba(107, 42, 255, 0.5);
            box-shadow: 0 0 20px rgba(107, 42, 255, 0.6);
        }
    </style>
</head>

<body>
    <script>
        // Apply dark mode immediately when body starts rendering
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <!-- Dark Mode Toggle Button -->
    <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon" id="darkModeIcon"></i>
        <span id="darkModeText">Dark Mode</span>
    </button>

    <div class="result-container fade-in">
        <div class="result-header">
            <h2 class="text-primary mb-3">Your Result</h2>

            <div class="verdict-badge" id="verdict-badge">GOOD</div>

            <div class="score-display">
                <span id="score-value">0</span> / 5
            </div>

            <div class="progress-info">
                <div>Question: <span id="current-question">1</span> / <span id="total-questions">5</span></div>
                <div>Total Score: <span id="total-score">0</span></div>
            </div>
        </div>

        <div class="evaluation-box">
            <h5 class="mb-3 text-primary">AI Evaluation</h5>
            <div class="evaluation-text" id="evaluation-text">
                Loading evaluation...
            </div>

            <!-- Lazy reveal control for long evaluations -->
            <button id="loadMoreEval" class="btn btn-sm btn-outline-primary mt-2 d-none">
                Continue ...
            </button>

            <!-- Like / Dislike controls -->
            <div class="mt-3 d-flex align-items-center gap-2" id="feedback-controls">
                <button id="like-btn" class="btn btn-outline-success" title="Like feedback">
                    <i class="fas fa-thumbs-up"></i>
                </button>
                <button id="dislike-btn" class="btn btn-outline-danger" title="Dislike feedback">
                    <i class="fas fa-thumbs-down"></i>
                </button>
                <div id="feedback-status" class="text-muted small">&nbsp;</div>
            </div>
        </div>

        <div class="btn-container">
            <button type="button" class="btn btn-outline-secondary" onclick="goHome()">
                <i class="fas fa-home me-2"></i>Home
            </button>
            <button type="button" class="btn btn-primary btn-next" id="next-btn">
                <i class="fas fa-arrow-right me-2"></i>Next Question
            </button>
        </div>
    </div>

    <script>
        // Load result data from localStorage
        const resultData = JSON.parse(localStorage.getItem('resultData') || '{}');
        const gameState = JSON.parse(localStorage.getItem('gameState') || '{}');

        if (!resultData || !("evaluation" in resultData)) {
            // No result data - redirect to theme selection
            window.location.href = '/auth/theme-selection';
        }


        // Display result data (evaluation handled via lazy loader below)
        document.getElementById('score-value').textContent = resultData.score || 0;
        document.getElementById('current-question').textContent = (resultData.currentIndex + 1) || 1;
        document.getElementById('total-questions').textContent = resultData.totalQuestions || 5;
        document.getElementById('total-score').textContent = resultData.totalScore || 0;

        // Update verdict badge
        const verdictBadge = document.getElementById('verdict-badge');
        const verdict = resultData.verdict || 'EVALUATED';
        verdictBadge.textContent = verdict;

        if (verdict === 'GOOD' || (resultData.score && resultData.score >= 5)) {
            verdictBadge.className = 'verdict-badge verdict-good';
        } else {
            verdictBadge.className = 'verdict-badge verdict-bad';
        }

        // Update game state score
        gameState.totalScore = resultData.totalScore || 0;
        gameState.currentIndex = (resultData.currentIndex || 0) + 1;

        // Handle next question button
        document.getElementById('next-btn').addEventListener('click', () => {
            if (gameState.currentIndex >= gameState.questions.length) {
                // Game complete - go to leaderboard
                window.location.href = `/questions/leaderboard?theme=${resultData.theme}`;
            } else {
                // Load next question
                localStorage.setItem('gameState', JSON.stringify(gameState));
                loadNextQuestion();
            }
        });

        function loadNextQuestion() {
            const question = gameState.questions[gameState.currentIndex];

            // Create form data for next question page
            const nextQuestionData = {
                questions: gameState.questions,
                currentIndex: gameState.currentIndex,
                totalScore: gameState.totalScore,
                userId: gameState.userId,
                theme: gameState.theme
            };

            localStorage.setItem('nextQuestionData', JSON.stringify(nextQuestionData));
            window.location.href = `/questions/next`;
        }

        function goHome() {
            localStorage.clear();
            window.location.href = '/auth/theme-selection';
        }

        // Update button text if last question
        if (gameState.currentIndex >= gameState.questions.length) {
            const nextBtn = document.getElementById('next-btn');
            nextBtn.innerHTML = '<i class="fas fa-trophy me-2"></i>View Leaderboard';
        }

        // --- Lazy-load long evaluation text: 40-word chunks ---
        (function setupLazyEvaluation() {
            const CHUNK_SIZE = 50; // words per chunk
            const WORD_DELAY_MS = 100; // typing speed per word
            const evalEl = document.getElementById('evaluation-text');
            const moreBtn = document.getElementById('loadMoreEval');

            if (!evalEl || !moreBtn) return;

            const state = { chunks: [], shown: 0, typing: false };

            function buildChunks(text) {
                const words = (text || '').trim().replace(/\s+/g, ' ').split(' ').filter(Boolean);
                const chunks = [];
                for (let i = 0; i < words.length; i += CHUNK_SIZE) {
                    chunks.push(words.slice(i, i + CHUNK_SIZE).join(' '));
                }
                return chunks;
            }

            function clearEval() {
                while (evalEl.firstChild) evalEl.removeChild(evalEl.firstChild);
            }

            function typeWords(el, text, onDone) {
                const words = (text || '').split(' ');
                let i = 0;
                state.typing = true;

                function step() {
                    if (i >= words.length) {
                        state.typing = false;
                        onDone && onDone();
                        return;
                    }
                    const chunk = (i === 0 ? '' : ' ') + words[i++];
                    el.appendChild(document.createTextNode(chunk));
                    setTimeout(step, WORD_DELAY_MS);
                }
                step();
            }

            function renderNext() {
                if (state.typing) return; // avoid double-trigger while typing
                if (state.shown >= state.chunks.length) return;

                const p = document.createElement('p');
                p.className = 'mb-2';
                evalEl.appendChild(p);

                // Disable button and show typing status while animating
                moreBtn.disabled = true;
                const prevLabel = moreBtn.textContent;
                moreBtn.textContent = '...';

                const text = state.chunks[state.shown++];
                typeWords(p, text, () => {
                    if (state.shown >= state.chunks.length) {
                        moreBtn.classList.add('d-none');
                    } else {
                        moreBtn.disabled = false;
                        moreBtn.textContent = prevLabel || 'Continue ...';
                    }
                });
            }

            function init(text) {
                state.chunks = buildChunks(text);
                state.shown = 0;
                clearEval();

                if (state.chunks.length === 0) {
                    evalEl.textContent = 'No evaluation available.';
                    moreBtn.classList.add('d-none');
                    return;
                }

                // Prepare button label
                moreBtn.textContent = 'Continue ...';

                // Show first chunk automatically (with typing)
                renderNext();

                // Toggle button visibility
                if (state.chunks.length > 1) {
                    moreBtn.classList.remove('d-none');
                } else {
                    moreBtn.classList.add('d-none');
                }
            }

            moreBtn.addEventListener('click', renderNext);

            // Initialize with the evaluation string from localStorage
            init(resultData.evaluation || '');
        })();

        // --- Feedback (Like / Dislike) handling ---
        (function setupFeedbackControls() {
            const likeBtn = document.getElementById('like-btn');
            const dislikeBtn = document.getElementById('dislike-btn');
            const status = document.getElementById('feedback-status');

            // Read identifiers saved by question page
            const playerId = resultData.player_id || resultData.userId || null;
            const questionId = resultData.question_id || null;

            function setStatus(text) {
                status.textContent = text;
            }

            async function sendFeedback(liked) {
                if (!playerId || !questionId) {
                    setStatus('Unable to send feedback (missing ids).');
                    return;
                }

                // Optimistic UI
                likeBtn.classList.toggle('active', liked === true);
                dislikeBtn.classList.toggle('active', liked === false);
                setStatus('Saving...');

                try {
                    const resp = await fetch(`/responses/${playerId}/${questionId}/feedback`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ liked: Boolean(liked) })
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(errText || 'Server error');
                    }

                    const json = await resp.json();
                    setStatus(json.liked ? 'You liked this feedback' : 'You disliked this feedback');
                } catch (err) {
                    console.error('Feedback error', err);
                    setStatus('Failed to save feedback');
                    // revert optimistic state
                    likeBtn.classList.remove('active');
                    dislikeBtn.classList.remove('active');
                }
            }

            likeBtn.addEventListener('click', () => sendFeedback(true));
            dislikeBtn.addEventListener('click', () => sendFeedback(false));
        })();

        // Dark mode toggle functions
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeButton(isDarkMode);
        }

        function updateDarkModeButton(isDarkMode) {
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');

            if (isDarkMode) {
                icon.className = 'fas fa-sun';
                text.textContent = 'Light Mode';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = 'Dark Mode';
            }
        }

        // Initialize button state
        if (localStorage.getItem('darkMode') === 'true') {
            updateDarkModeButton(true);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>